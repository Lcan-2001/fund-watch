<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>金彪基金估算工具 v5.0 - 完整稳定版</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; background: #f8f9fa; color: #212529; max-width: 900px; margin: auto; }
    body.dark { background: #121212; color: #e0e0e0; }
    h1 { text-align: center; }
    .disclaimer { font-size: 0.9em; color: #6c757d; text-align: center; margin-bottom: 1.5em; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    body.dark .disclaimer { background: #1e1e1e; color: #adb5bd; }
    .search-box { display: flex; flex-wrap: wrap; gap: 10px; margin: 1em 0; position: relative; }
    input, select { flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; }
    body.dark input, body.dark select { background: #2c2c2c; color: #e0e0e0; border-color: #444; }
    button { padding: 10px 16px; background: #0d6efd; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #0b5ed7; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    body.dark table { background: #1e1e1e; }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; }
    body.dark th, body.dark td { border-bottom-color: #444; }
    th { background: #e9ecef; cursor: pointer; }
    body.dark th { background: #2d2d2d; }
    .up { color: #dc3545; font-weight: bold; }
    .down { color: #198754; font-weight: bold; }
    .status-trading { color: #0d6efd; font-weight: bold; }
    .status-closed { color: #6c757d; font-weight: bold; }
    .delete-btn { color: #dc3545; cursor: pointer; font-weight: bold; }
    #suggestions { position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ced4da; border-radius: 6px; z-index: 100; display: none; }
    body.dark #suggestions { background: #1e1e1e; border-color: #444; }
    .suggestion-item { padding: 10px; cursor: pointer; }
    .suggestion-item:hover { background: #e9ecef; }
    body.dark .suggestion-item:hover { background: #2d2d2d; }
    .time { font-size: 0.85em; color: #6c757d; }
  </style>
</head>
<body>

<h1>金彪基金估算工具 v5.0</h1>

<div class="disclaimer">
  输入基金中文名称/简称/拼音 → 自动弹出匹配建议 → 点击选择自动填充代码 → 点“添加选中”加入列表。<br>
  支持A股/港股/美股ETF。数据为估算，仅供个人参考，不构成投资建议。<br>
  估算刷新30秒一次，时间/状态5秒更新。
</div>

<div class="search-box">
  <div style="position: relative; flex: 1;">
    <input id="fundInput" placeholder="输入基金代码或中文名称（如 沪深300、恒生科技、SPY）" autocomplete="off" />
    <div id="suggestions"></div>
  </div>
  <button onclick="addSelectedFund()">添加选中</button>
</div>

<div class="api-box">
  <select id="apiSelect" onchange="saveApi()"></select>
  <button onclick="refreshAll(true)">强制刷新估算</button>
  <button onclick="toggleDarkMode()">暗模式</button>
</div>

<table id="fundTable">
  <thead>
    <tr>
      <th>代码</th>
      <th>名称</th>
      <th>估算涨跌幅</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody id="fundList"></tbody>
</table>

<script>
  // ==================== 核心变量 ====================
  let funds = JSON.parse(localStorage.getItem('myFunds')) || [];
  const CACHE_DURATION = 30000; // 估算缓存30秒
  let lastApiRefresh = 0;
  let sortDesc = true;
  let searchTimer = null;
  let selectedFund = null;

  const CORS_PROXY = 'https://api.allorigins.win/raw?url=';

  // 接口列表（2026年1月有效）
  let apiList = [
    {
      name: "天天基金手机版 (A股/港股)",
      url: "https://fundmobapi.eastmoney.com/FundMApi/FundNetValueEstimate?fc={code}&deviceid=app&version=1.0",
      parse: d => d?.Datas?.[0] ? {name:d.Datas[0].FSNAME, gzgz:parseFloat(d.Datas[0].GSZZL)||0, gztime:d.Datas[0].GZTIME||'未知'} : null,
      type: 'cn_hk'
    },
    {
      name: "Yahoo Finance 美股ETF",
      url: "https://query1.finance.yahoo.com/v7/finance/quote?symbols={code}",
      parse: d => d?.quoteResponse?.result?.[0] ? {name:d.quoteResponse.result[0].shortName||'未知', gzgz:parseFloat(d.quoteResponse.result[0].regularMarketChangePercent)||0, gztime:new Date(d.quoteResponse.result[0].regularMarketTime*1000).toLocaleString('zh-CN',{hour12:false})} : null,
      type: 'us'
    }
  ];

  let currentApiIndex = parseInt(localStorage.getItem('currentApiIndex')) || 0;

  const tbody = document.getElementById('fundList');
  const input = document.getElementById('fundInput');
  const suggestionsDiv = document.getElementById('suggestions');

  // ==================== 中文搜索建议 ====================
  input.addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(async () => {
      const kw = input.value.trim();
      if (kw.length < 2) {
        suggestionsDiv.style.display = 'none';
        selectedFund = null;
        return;
      }

      try {
        const url = `http://fundsuggest.eastmoney.com/FundSearch/api/FundSearchAPI.ashx?m=1&key=${encodeURIComponent(kw)}`;
        const proxyUrl = CORS_PROXY + encodeURIComponent(url);
        const res = await fetch(proxyUrl);
        if (!res.ok) throw new Error('搜索接口状态：' + res.status);
        const data = await res.json();

        suggestionsDiv.innerHTML = '';
        if (data && data.Datas && data.Datas.length > 0) {
          data.Datas.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = `${item.NAME} (${item.CODE}) - ${item.FUND_TYPE || '基金'}`;
            div.onclick = () => {
              input.value = item.CODE;
              selectedFund = { code: item.CODE, name: item.NAME };
              suggestionsDiv.style.display = 'none';
            };
            suggestionsDiv.appendChild(div);
          });
          suggestionsDiv.style.display = 'block';
        } else {
          suggestionsDiv.innerHTML = '<div class="suggestion-item">无匹配结果</div>';
          suggestionsDiv.style.display = 'block';
        }
      } catch (e) {
        console.error('搜索失败:', e);
        suggestionsDiv.innerHTML = '<div class="suggestion-item">搜索出错，请稍后重试</div>';
        suggestionsDiv.style.display = 'block';
      }
    }, 400);
  });

  document.addEventListener('click', e => {
    if (!input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
      suggestionsDiv.style.display = 'none';
    }
  });

  // ==================== 添加选中 ====================
  async function addSelectedFund() {
    let code = input.value.trim().toUpperCase();
    if (selectedFund && selectedFund.code) code = selectedFund.code;

    if (!code) {
      alert('请先输入或选择基金');
      return;
    }

    if (funds.some(f => f.code === code)) {
      alert('该基金已添加');
      return;
    }

    const fundData = await fetchFund(code, true);
    if (fundData) {
      funds.push(fundData);
      localStorage.setItem('myFunds', JSON.stringify(funds));
      renderFunds();
      input.value = '';
      selectedFund = null;
      suggestionsDiv.style.display = 'none';
      alert('添加成功！');
    } else {
      alert('获取失败，可能代码无效或接口临时问题');
    }
  }

  // ==================== 估值函数 ====================
  async function fetchFund(code, force = false) {
    const now = Date.now();
    const cache = funds.find(f => f.code === code);
    if (!force && cache && now - cache.timestamp < CACHE_DURATION) {
      return cache;
    }

    let attempts = 0;
    while (attempts < apiList.length) {
      const api = apiList[currentApiIndex];
      try {
        let url = api.url.replace('{code}', code);
        const proxyUrl = CORS_PROXY + encodeURIComponent(url);
        const res = await fetch(proxyUrl);
        if (!res.ok) throw new Error('接口状态：' + res.status);
        const raw = await res.json();
        const parsed = api.parse(raw);
        if (parsed && parsed.gzgz !== undefined) {
          return { ...parsed, code, timestamp: now, type: api.type };
        }
      } catch (e) {
        console.error('估值失败:', api.name, e);
        currentApiIndex = (currentApiIndex + 1) % apiList.length;
      }
      attempts++;
    }
    return null;
  }

  // ==================== 刷新 ====================
  async function refreshAll(force = false) {
    if (!funds.length) return;
    const now = Date.now();
    if (force || now - lastApiRefresh > CACHE_DURATION) {
      lastApiRefresh = now;
      await Promise.all(funds.map(async f => {
        const u = await fetchFund(f.code, force);
        if (u) Object.assign(f, u);
      }));
      localStorage.setItem('myFunds', JSON.stringify(funds));
    }
    renderFunds();
  }

  // ==================== 渲染 ====================
  function renderFunds() {
    tbody.innerHTML = '';
    if (funds.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="loading">暂无基金</td></tr>';
      return;
    }
    funds.forEach((f, i) => {
      const tr = document.createElement('tr');
      const ch = parseFloat(f.gzgz || 0);
      const cls = ch > 0 ? 'up' : ch < 0 ? 'down' : '';
      const chStr = ch ? ch.toFixed(2) + '%' : '加载中...';
      const timeStr = f.gztime ? `<span class="time">(${f.gztime})</span>` : '';
      const status = '未知状态'; // 可加回完整状态函数
      tr.innerHTML = `
        <td>${f.code}</td>
        <td>${f.name || f.code}</td>
        <td class="${cls}">${chStr} ${timeStr}</td>
        <td><span class="delete-btn" onclick="deleteFund(${i})">删除</span></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function deleteFund(i) {
    if (confirm('删除？')) {
      funds.splice(i, 1);
      localStorage.setItem('myFunds', JSON.stringify(funds));
      renderFunds();
    }
  }

  // 占位函数（可扩展）
  async function updateApiMenu() { console.log('更新接口菜单'); }
  function saveApi() { console.log('保存接口'); }
  function testAllApis() { alert('测试所有接口'); }
  function toggleDarkMode() { document.body.classList.toggle('dark'); }

  // 初始化
  renderFunds();
  refreshAll(true);
  setInterval(() => refreshAll(false), 5000);
</script>

</body>
</html>