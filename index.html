<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>金彪基金估算工具 v5.0 - 长效完善版</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; background: #f8f9fa; color: #212529; max-width: 900px; margin: auto; transition: background 0.3s, color 0.3s; }
    body.dark { background: #121212; color: #e0e0e0; }
    h1 { text-align: center; }
    .disclaimer { font-size: 0.9em; color: #6c757d; text-align: center; margin-bottom: 1.5em; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    body.dark .disclaimer { background: #1e1e1e; color: #adb5bd; }
    .search-box { display: flex; flex-wrap: wrap; gap: 10px; margin: 1em 0; position: relative; }
    input, select, textarea { flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; }
    body.dark input, body.dark select, body.dark textarea { background: #2c2c2c; color: #e0e0e0; border-color: #444; }
    button { padding: 10px 16px; background: #0d6efd; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #0b5ed7; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    body.dark table { background: #1e1e1e; }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; }
    body.dark th, body.dark td { border-bottom-color: #444; }
    th { background: #e9ecef; cursor: pointer; }
    body.dark th { background: #2d2d2d; }
    .up { color: #dc3545; font-weight: bold; }
    .down { color: #198754; font-weight: bold; }
    .status-trading { color: #0d6efd; font-weight: bold; }
    .status-closed { color: #6c757d; font-weight: bold; }
    .delete-btn { color: #dc3545; cursor: pointer; font-weight: bold; }
    #suggestions { position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ced4da; border-radius: 6px; z-index: 100; display: none; }
    body.dark #suggestions { background: #1e1e1e; border-color: #444; }
    .suggestion-item { padding: 10px; cursor: pointer; }
    .suggestion-item:hover { background: #e9ecef; }
    body.dark .suggestion-item:hover { background: #2d2d2d; }
    .time { font-size: 0.85em; color: #6c757d; }
    .config { margin-top: 2em; padding: 1em; background: white; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    body.dark .config { background: #1e1e1e; }
  </style>
</head>
<body>

<h1>金彪基金估算工具 v5.0 - 长效完善版</h1>

<div class="disclaimer">
  输入基金中文名称/简称/拼音 → 自动弹出匹配建议 → 点击选择自动添加。<br>
  支持A股/港股/美股ETF。数据为估算，仅供个人参考，不构成任何投资建议。<br>
  估算刷新30秒一次，时间/状态5秒更新。
</div>

<div class="search-box">
  <div style="position: relative; flex: 1;">
    <input id="fundInput" placeholder="输入基金代码或中文名称（如 沪深300、恒生科技、SPY）" autocomplete="off" />
    <div id="suggestions"></div>
  </div>
  <button onclick="addSelectedFund()">添加选中</button>
</div>

<div class="api-box">
  <select id="apiSelect" onchange="saveApi()"></select>
  <button onclick="refreshAll(true)">强制刷新估算</button>
  <button onclick="toggleDarkMode()">切换暗模式</button>
</div>

<table id="fundTable">
  <thead>
    <tr>
      <th>代码</th>
      <th>名称</th>
      <th>估算涨跌幅</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody id="fundList"></tbody>
</table>

<script>
  // 核心变量
  let funds = JSON.parse(localStorage.getItem('myFunds')) || [];
  const CACHE_DURATION = 30000; // 估算缓存30秒
  let lastApiRefresh = 0;
  let sortDesc = true;
  let searchTimer = null;
  let selectedFund = null;

  const CORS_PROXY = 'https://api.allorigins.win/raw?url=';

  // 接口列表
  let apiList = [
    { name: "新浪财经 (稳定备份)", url: "https://hq.sinajs.cn/list={code}", parse: t => {
      const m = t.match(/var hq_str_(.*?)="(.*?)";/);
      if (m) {
        const f = m[2].split(',');
        return {name:f[0]||'未知', gzgz:parseFloat(f[8])||0, gztime:new Date().toLocaleString('zh-CN',{hour12:false})};
      }
      return null;
    }, type: 'cn_hk' },
    { name: "Yahoo Finance (美股)", url: "https://query1.finance.yahoo.com/v7/finance/quote?symbols={code}", parse: d => d?.quoteResponse?.result?.[0] ? {name:d.quoteResponse.result[0].shortName||'未知', gzgz:parseFloat(d.quoteResponse.result[0].regularMarketChangePercent)||0, gztime:new Date(d.quoteResponse.result[0].regularMarketTime*1000).toLocaleString('zh-CN',{hour12:false})} : null, type: 'us' }
  ];

  let currentApiIndex = parseInt(localStorage.getItem('currentApiIndex')) || 0;

  const tbody = document.getElementById('fundList');
  const apiSelect = document.getElementById('apiSelect');
  const input = document.getElementById('fundInput');
  const suggestionsDiv = document.getElementById('suggestions');

  // 判断节假日
  function isHoliday(dateStr) {
    const date = dateStr.split(' ')[0];
    return holidayDates2026.includes(date);
  }

  // 当前时间字符串
  function getCurrentTimeStr() {
    return new Date().toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
  }

  // 市场状态
  function getMarketStatus(gztime, type) {
    if (!gztime || gztime === '未知') return '休市';

    const m = gztime.match(/(\d{4}-\d{2}-\d{2}) (\d{2}:\d{2})/);
    if (!m) return '休市';

    const gz = new Date(m[1] + 'T' + m[2] + ':00+08:00');
    const now = new Date();

    if (gz.toDateString() !== now.toDateString()) return '休市';
    if (isHoliday(m[1])) return '休市';

    const h = gz.getHours(), min = gz.getMinutes();
    let trading = false;

    if (type === 'us') {
      trading = (h >= 21 || h < 4) || (h === 4 && min <= 0);
    } else if (type === 'hk') {
      trading = (h >= 9 && h < 16) || (h === 9 && min >= 30) || (h === 16 && min <= 10);
    } else {
      trading = ((h >= 9 && h < 11) || (h === 9 && min >= 30) || (h === 11 && min < 30)) ||
                ((h >= 13 && h < 15) || (h === 15 && min <= 0));
    }

    return trading ? `交易中 ${getCurrentTimeStr()}` : '休市';
  }

  // 渲染列表
  function renderFunds() {
    tbody.innerHTML = '';
    if (funds.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="loading">暂无基金</td></tr>';
      return;
    }
    funds.forEach((f, i) => {
      const tr = document.createElement('tr');
      const ch = parseFloat(f.gzgz || 0);
      const cls = ch > 0 ? 'up' : ch < 0 ? 'down' : '';
      const chStr = ch ? ch.toFixed(2) + '%' : '加载中...';
      const timeStr = f.gztime ? `<span class="time">(${f.gztime})</span>` : '';
      const type = f.type || 'cn';
      const status = getMarketStatus(f.gztime, type);
      const stCls = status.includes('交易中') ? 'status-trading' : 'status-closed';
      tr.innerHTML = `
        <td>${f.code}</td>
        <td>${f.name || f.code}</td>
        <td class="${cls}">${chStr} ${timeStr} <span class="${stCls}">[${status}]</span></td>
        <td><span class="delete-btn" onclick="deleteFund(${i})">删除</span></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // 初始化
  renderFunds();
  setInterval(refreshAll, 30000); // 30秒刷新估算
</script>

</body>
</html>
