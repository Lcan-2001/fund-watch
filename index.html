<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>金彪基金估算工具 v3.0 - 长效版</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; background: #f8f9fa; color: #212529; max-width: 900px; margin: auto; }
    body.dark { background: #121212; color: #e0e0e0; }
    h1 { text-align: center; }
    .disclaimer { font-size: 0.9em; color: #6c757d; text-align: center; margin-bottom: 1.5em; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    body.dark .disclaimer { background: #1e1e1e; color: #adb5bd; }
    .search-box { display: flex; flex-wrap: wrap; gap: 10px; margin: 1em 0; position: relative; }
    input, select, textarea { flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; }
    body.dark input, body.dark select, body.dark textarea { background: #2c2c2c; color: #e0e0e0; border-color: #444; }
    button { padding: 10px 16px; background: #0d6efd; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #0b5ed7; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    body.dark table { background: #1e1e1e; }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; }
    body.dark th, body.dark td { border-bottom-color: #444; }
    th { background: #e9ecef; cursor: pointer; }
    body.dark th { background: #2d2d2d; }
    .up { color: #dc3545; font-weight: bold; }
    .down { color: #198754; font-weight: bold; }
    .status-trading { color: #0d6efd; font-weight: bold; }
    .status-closed { color: #6c757d; font-weight: bold; }
    .delete-btn { color: #dc3545; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>

<h1>金彪基金估算工具 v3.0 - 长效版</h1>

<div class="disclaimer">
  数据为估算，仅供个人参考，不构成投资建议。<br>
  支持A股/港股/美股ETF。接口失效时可手动添加新API URL。<br>
  估算刷新 ≈ 30秒一次，实时时间每5秒更新。
</div>

<div class="search-box">
  <input id="fundCode" placeholder="输入基金代码：510300 / 02800 / SPY" />
  <button onclick="addFund()">添加</button>
</div>

<div class="api-box">
  <select id="apiSelect" onchange="saveApi()"></select>
  <button onclick="refreshAll(true)">强制刷新估算</button>
  <button onclick="testAllApis()">测试所有接口</button>
  <button onclick="toggleDarkMode()">暗模式</button>
</div>

<table id="fundTable">
  <thead>
    <tr>
      <th>代码</th>
      <th>名称</th>
      <th onclick="sortFunds()">估算涨跌幅 <span id="sortArrow">▼</span></th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody id="fundList"></tbody>
</table>

<div class="config">
  <h3>添加/维护备用API（长效关键）</h3>
  <input id="customApiName" placeholder="接口名称（如新浪财经）" style="width:180px;" />
  <input id="customApiUrl" placeholder="URL模板，{code}为占位符" style="flex:2;" />
  <button onclick="addCustomApi()">添加此API</button><br><br>
  <small>示例：https://hq.sinajs.cn/list=sh{code} 或 https://query1.finance.yahoo.com/v7/finance/quote?symbols={code}</small>
</div>

<script>
  let funds = JSON.parse(localStorage.getItem('myFunds')) || [];
  const CACHE_DURATION = 30000; // 30秒
  let lastApiRefresh = 0;
  let sortDesc = true;

  const CORS_PROXY = 'https://api.allorigins.win/raw?url=';

  let apiList = [
    { name: "天天基金手机版 (最稳定A股/港股)", url: "https://fundmobapi.eastmoney.com/FundMApi/FundNetValueEstimate?fc={code}&deviceid=app&version=1.0", parse: d => d?.Datas?.[0] ? {name:d.Datas[0].FSNAME, gzgz:parseFloat(d.Datas[0].GSZZL)||0, gztime:d.Datas[0].GZTIME||'未知'} : null, type: 'cn_hk' },
    { name: "Yahoo Finance (美股ETF)", url: "https://query1.finance.yahoo.com/v7/finance/quote?symbols={code}", parse: d => d?.quoteResponse?.result?.[0] ? {name:d.quoteResponse.result[0].shortName||'未知', gzgz:parseFloat(d.quoteResponse.result[0].regularMarketChangePercent)||0, gztime:new Date(d.quoteResponse.result[0].regularMarketTime*1000).toLocaleString('zh-CN',{hour12:false})} : null, type: 'us' },
    { name: "新浪财经快照 (A股/港股备份)", url: "https://hq.sinajs.cn/list=sh{code}", parse: t => {
      const m = t.match(/var hq_str_sh(.*?)="(.*?)";/);
      if (m) {
        const f = m[2].split(',');
        return {name:f[0]||'未知', gzgz:parseFloat(f[8])||0, gztime:new Date().toLocaleString('zh-CN',{hour12:false})};
      }
      return null;
    }, type: 'cn_hk' }
  ];

  let currentApiIndex = parseInt(localStorage.getItem('currentApi')) || 0;

  const tbody = document.getElementById('fundList');
  const apiSelect = document.getElementById('apiSelect');

  // 渲染列表
  function renderFunds() {
    tbody.innerHTML = '';
    if (funds.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="loading">暂无自选基金</td></tr>';
      return;
    }
    funds.forEach((f, i) => {
      const tr = document.createElement('tr');
      const ch = parseFloat(f.gzgz || 0);
      const cls = ch > 0 ? 'up' : ch < 0 ? 'down' : '';
      const chStr = ch ? ch.toFixed(2) + '%' : '加载中...';
      const timeStr = f.gztime ? `<span class="time">(${f.gztime})</span>` : '';
      tr.innerHTML = `
        <td>${f.code}</td>
        <td>${f.name || f.code}</td>
        <td class="${cls}">${chStr} ${timeStr}</td>
        <td><span class="delete-btn" onclick="deleteFund(${i})">删除</span></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // 初始化
  renderFunds();
</script>

</body>
</html>
